/*
1. En la base de datos VUELOS (varias tablas) crea una función que reciba el identificador de
un vuelo y devuelva un número entero con la cantidad de reservas que hay para dicho
vuelo.
*/

CREATE OR REPLACE FUNCTION cantidadReservas(id integer)
RETURNS integer AS $$
	SELECT COUNT(id_reserva)
	FROM reserva JOIN vuelo USING (id_vuelo)
	WHERE id_vuelo = $1
$$ LANGUAGE 'sql';

SELECT *
FROM cantidadReservas(1);

/*
2. En la misma base de datos, crea una función que reciba una fecha y una cadena de
caracteres y seleccione todos los vuelos que salen o llegan ese día de un aeropuerto o
ciudad cuyo nombre sea el que se ha pasado como segundo argumento (la cadena de
caracteres). El resultado a mostrar debe ser: aeropuerto de salida, ciudad de salida, fecha
y hora de salida, aeropuerto de llegada, ciudad de llegada, fecha y hora de llegada, nº
máximo de pasajeros del avión, nº de reservas que hay actualmente (para mostrar este
último argumento, debes utilizar la función definida en el apartado anterior.
*/

CREATE OR REPLACE FUNCTION vuelosLS (fecha date, ciudad varchar)
RETURNS TABLE (nombre_salida varchar, ciudad_salida varchar, fecha_salida timestamp,
			   nombre_llegada varchar, ciudad_llegada varchar, fecha_llegada timestamp,
			   max_pasajeros integer, total_reservas integer) AS $$
	SELECT ae.nombre, ae.ciudad, salida, aeh.nombre, aeh.ciudad, llegada, max_pasajeros, (SELECT *
																						  FROM cantidadReservas(id_vuelo))
	FROM avion JOIN vuelo USING (id_avion)
		 JOIN aeropuerto ae ON (desde = ae.id_aeropuerto)
		 JOIN aeropuerto aeh ON (hasta = aeh.id_aeropuerto)
	WHERE (ae.ciudad = $2 OR aeh.ciudad = $2) AND ((TO_CHAR(llegada, 'YYYY/MM/DD')::date = $1) OR (TO_CHAR(salida, 'YYYY/MM/DD')::date = $1)
		   OR (ae.nombre = $2 OR aeh.nombre = $2))
$$ LANGUAGE 'sql';

SELECT *
FROM vuelosLS('2021/08/25','Sevilla');

/*
3. En la misma base de datos, crea una función que nos permita crear un nuevo vuelo. Debe
recibir como argumento: ciudad de salida, ciudad de llegada, fecha y hora de salida, fecha
y hora de llegada, precio y descuento. Debe insertar una nueva fila en vuelo, obteniendo el
ID de los aeropuertos a partir de sus nombres, y estableciendo un avión aleatorio (puedes
consultar cómo obtener una fila aleatoria de una tabla en este enlace:
*/

CREATE OR REPLACE FUNCTION crearVuelo(ciudadS varchar(100), ciudadL varchar(100),
									  fechaS timestamp, fechaL timestamp,
									  precio numeric, descuento integer)
RETURNS void AS $$
	INSERT INTO VUELO (ID_VUELO, SALIDA, DESDE, LLEGADA, HASTA, PRECIO, DESCUENTO, ID_AVION) 
	VALUES ((SELECT MAX(id_vuelo)+1
		    FROM vuelo), $3, (SELECT id_aeropuerto
							  FROM aeropuerto
							  WHERE ciudad = $1), $4, (SELECT id_aeropuerto
													   FROM aeropuerto
				 									   WHERE ciudad = $2),
			 $5, $6, (SELECT id_avion
		   			 FROM avion
		   			 ORDER BY random()
		   			 LIMIT 1))
$$ LANGUAGE 'sql';

SELECT *
FROM crearVuelo('Sevilla', 'Barcelona', '2022-04-19 12:25:00', '2022-04-19 14:30:00', 120, 25);

SELECT *
FROM vuelo
ORDER BY id_vuelo DESC;